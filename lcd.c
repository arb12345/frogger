#include "lcd.h"

// LCD Real Screen Dimensions
#define LCD_VERTICAL_MAX                   128
#define LCD_HORIZONTAL_MAX                 128

#define LCD_ORIENTATION_UP    0
#define LCD_ORIENTATION_LEFT  1
#define LCD_ORIENTATION_DOWN  2
#define LCD_ORIENTATION_RIGHT 3

#define LCD_SPICLK_SEL		P3SEL
#define LCD_SPICLK_PIN		BIT2
#define LCD_RST_DIR			P7DIR
#define LCD_RST_OUT			P7OUT
#define LCD_RST_PIN			BIT4
#define LCD_SPIMOSI_SEL 	P3SEL
#define LCD_SPIMOSI_PIN 	BIT0
#define LCD_CS_DIR			P2DIR
#define LCD_CS_OUT			P2OUT
#define LCD_CS_PIN			BIT6
#define LCD_DC_DIR			P8DIR
#define LCD_DC_OUT			P8OUT
#define LCD_DC_PIN			BIT2



#define LCD_COL_START 		2
#define LCD_ROW_START 		3

// ST7735 LCD controller Command Set
#define CM_NOP             0x00
#define CM_SWRESET         0x01
#define CM_RDDID           0x04
#define CM_RDDST           0x09
#define CM_SLPIN           0x10
#define CM_SLPOUT          0x11
#define CM_PTLON           0x12
#define CM_NORON           0x13
#define CM_INVOFF          0x20
#define CM_INVON           0x21
#define CM_GAMSET          0x26
#define CM_DISPOFF         0x28
#define CM_DISPON          0x29
#define CM_CASET           0x2A
#define CM_RASET           0x2B
#define CM_RAMWR           0x2C
#define CM_RGBSET          0x2d
#define CM_RAMRD           0x2E
#define CM_PTLAR           0x30
#define CM_MADCTL          0x36
#define CM_COLMOD          0x3A
#define CM_SETPWCTR        0xB1
#define CM_SETDISPL        0xB2
#define CM_FRMCTR3         0xB3
#define CM_SETCYC          0xB4
#define CM_SETBGP          0xb5
#define CM_SETVCOM         0xB6
#define CM_SETSTBA         0xC0
#define CM_SETID           0xC3
#define CM_GETHID          0xd0
#define CM_SETGAMMA        0xE0
#define CM_MADCTL_MY       0x80
#define CM_MADCTL_MX       0x40
#define CM_MADCTL_MV       0x20
#define CM_MADCTL_ML       0x10
#define CM_MADCTL_BGR      0x08
#define CM_MADCTL_MH       0x04

static const uint8_t lcd_ascii_img[] =
{
		0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x0F, 0x0F, 0x00, 0x0F, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0xFF,
		0x00, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x0F, 0xFF, 0x00, 0x00, 0xF0, 0x00, 0x0F, 0xFF, 0x00, 0xFF, 0xFF, 0xF0, 0x00, 0x0F, 0x00, 0xFF,
		0xFF, 0xF0, 0x00, 0xFF, 0x00, 0xFF, 0xFF, 0xF0, 0x0F, 0xFF, 0x00, 0x0F, 0xFF, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x0F, 0xFF, 0x00,
		0x0F, 0xFF, 0x00, 0x0F, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x0F, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF,
		0xFF, 0xF0, 0xFF, 0xFF, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0x00, 0xFF,
		0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x0F, 0xFF, 0x00,
		0xFF, 0xFF, 0x00, 0x0F, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x0F, 0xFF, 0x00, 0xFF, 0xFF, 0xF0, 0xF0,
		0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xFF, 0xFF,
		0xF0, 0x00, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00,
		0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00,
		0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00,
		0xF0, 0xF0, 0x00, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0xF0, 0x00, 0x0F, 0x0F, 0x00, 0x0F, 0x0F, 0x00, 0x0F, 0xFF, 0xF0, 0xFF, 0x00, 0xF0, 0xF0,
		0x0F, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0x00, 0xF0,
		0x0F, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0x0F, 0x00, 0x00, 0xFF, 0x00, 0xF0, 0x00, 0x00, 0x0F,
		0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0xFF, 0x00, 0x00, 0xFF,
		0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0,
		0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0x00, 0xF0,
		0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0xF0, 0x0F,
		0x00, 0xF0, 0x00, 0x00, 0xFF, 0x0F, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0,
		0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0xF0,
		0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0xF0,
		0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00,
		0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x0F,
		0x00, 0xF0, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00,
		0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0,
		0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00,
		0x00, 0x00, 0x00, 0xFF, 0xFF, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0xF0, 0xF0, 0x00, 0x00,
		0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x0F, 0x00, 0xF0, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0xF0, 0x0F, 0xF0, 0x00, 0xF0, 0x00,
		0x00, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0x0F, 0x0F, 0x00, 0xFF, 0xFF, 0x00, 0xF0, 0x00, 0x00, 0x00,
		0x0F, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xF0,
		0x00, 0xFF, 0xFF, 0xF0, 0x00, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0xF0, 0x00, 0xF0,
		0xF0, 0x00, 0xF0, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0,
		0x00, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00,
		0x00, 0xF0, 0xF0, 0xF0, 0xFF, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0,
		0xF0, 0x00, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0,
		0x00, 0xF0, 0x0F, 0x0F, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0x0F, 0x00,
		0x00, 0x00, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x0F, 0xFF, 0x00,
		0xF0, 0xFF, 0x00, 0x0F, 0xFF, 0x00, 0x0F, 0xF0, 0xF0, 0x0F, 0xFF, 0x00, 0x0F, 0x00, 0x00, 0x0F,
		0xFF, 0xF0, 0xF0, 0xFF, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0xF0, 0xF0, 0x0F, 0x00, 0x00, 0xF0,
		0x00, 0xFF, 0x0F, 0x00, 0xF0, 0xFF, 0x00, 0x0F, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0x0F, 0xF0, 0xF0,
		0xF0, 0xFF, 0x00, 0x0F, 0xFF, 0x00, 0xFF, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0,
		0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xFF, 0xFF, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0xF0,
		0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00,
		0x0F, 0x0F, 0x00, 0x0F, 0xFF, 0x00, 0x00, 0xF0, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F,
		0x00, 0x00, 0x00, 0x0F, 0x00, 0x0F, 0xFF, 0x00, 0xFF, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0xFF, 0xFF,
		0xF0, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00,
		0x00, 0x0F, 0x00, 0xF0, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0xFF, 0x00, 0x00, 0xF0, 0x00, 0x0F,
		0xFF, 0x00, 0x0F, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0xF0, 0x00, 0x0F, 0x00, 0x0F, 0xF0, 0xF0, 0xF0, 0x00, 0xF0, 0xFF, 0xFF, 0x00,
		0xF0, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xF0, 0x0F, 0xF0, 0xFF,
		0xFF, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0xFF, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0xF0,
		0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0xF0, 0xFF, 0xFF, 0x00, 0xF0, 0x00, 0xF0, 0xFF, 0xFF, 0x00,
		0x0F, 0xFF, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x00,
		0xF0, 0x00, 0x0F, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00,
		0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0x00, 0xF0,
		0xF0, 0x00, 0x00, 0xF0, 0x0F, 0xF0, 0xF0, 0x00, 0xF0, 0xFF, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0xFF,
		0x00, 0xF0, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0,
		0xF0, 0xFF, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x0F, 0xF0, 0xFF, 0x00, 0xF0,
		0xF0, 0x00, 0x00, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x0F,
		0x0F, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0x0F, 0x00, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F,
		0x00, 0x0F, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xF0,
		0x00, 0xF0, 0xF0, 0x0F, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00,
		0x0F, 0x00, 0xF0, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x0F, 0x00, 0x00, 0xFF, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0xF0,
		0xFF, 0xFF, 0xF0, 0x00, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0x00,
		0x00, 0xF0, 0x00, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x00, 0xF0, 0x00, 0xFF, 0xFF, 0xF0, 0x00, 0x0F,
		0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0xF0, 0xFF, 0xFF, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0x00,
		0xF0, 0x00, 0xF0, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00,
		0xF0, 0x00, 0x00, 0x0F, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x0F,
		0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0xF0,
		0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x0F, 0x0F, 0x00, 0x00,
		0xF0, 0x00, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0x00,
		0xF0, 0x00, 0xF0, 0xFF, 0xFF, 0xF0, 0x0F, 0x00, 0x00, 0x0F, 0xFF, 0xF0, 0xF0, 0x00, 0xF0, 0x00,
		0xF0, 0x00, 0x00, 0x00, 0xF0, 0xFF, 0x00, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x00,
		0xF0, 0xF0, 0x00, 0xF0, 0xFF, 0xFF, 0x00, 0x0F, 0xFF, 0xF0, 0xF0, 0x00, 0x00, 0x0F, 0xFF, 0x00,
		0x0F, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0x0F,
		0xFF, 0xF0, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0x0F,
		0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0xFF, 0xFF, 0x00,
		0xF0, 0x0F, 0xF0, 0xF0, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00,
		0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0xF0, 0x00,
		0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0x0F, 0x00,
		0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0x0F, 0x00, 0x00,
		0xFF, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00,
		0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0,
		0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0,
		0x0F, 0x00, 0xF0, 0x0F, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00,
		0xF0, 0xF0, 0x00, 0x00, 0xF0, 0x0F, 0x00, 0xF0, 0x0F, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00,
		0xF0, 0x00, 0xF0, 0x0F, 0x0F, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0,
		0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0,
		0xF0, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0x0F,
		0x00, 0xF0, 0xF0, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00,
		0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x0F, 0x00, 0xF0,
		0xF0, 0x0F, 0xF0, 0x0F, 0x0F, 0x00, 0xF0, 0xF0, 0xF0, 0x0F, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x0F,
		0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x0F, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x0F, 0xF0,
		0x0F, 0xF0, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
		0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x0F, 0xFF,
		0x00, 0x0F, 0xFF, 0x00, 0xFF, 0xFF, 0xF0, 0x0F, 0xFF, 0x00, 0x00, 0x0F, 0x00, 0x0F, 0xFF, 0x00,
		0x0F, 0xFF, 0x00, 0x0F, 0x00, 0x00, 0x0F, 0xFF, 0x00, 0x0F, 0xF0, 0x00, 0x00, 0x00, 0x00, 0x00,
		0xF0, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x00, 0x00, 0x0F, 0x00, 0x00, 0x00, 0xF0, 0x00, 0x0F, 0xFF,
		0x00, 0xF0, 0x00, 0xF0, 0xFF, 0xFF, 0x00, 0x0F, 0xFF, 0x00, 0xFF, 0xFF, 0x00, 0xFF, 0xFF, 0xF0,
		0xF0, 0x00, 0x00, 0x0F, 0xFF, 0xF0, 0xF0, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0x0F, 0xF0, 0x00, 0xF0,
		0x00, 0xF0, 0xFF, 0xFF, 0xF0, 0xF0, 0x00, 0xF0, 0xF0, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x00,
		0x00, 0x0F, 0xF0, 0xF0, 0xF0, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0x00, 0xF0, 0x00, 0x0F, 0xFF, 0x00,
		0x00, 0xF0, 0x00, 0x0F, 0x0F, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xF0, 0x00, 0xFF, 0xFF, 0xF0, 0x00,
		0xFF, 0xF0, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xF0, 0x00, 0x00, 0x00, 0xFF, 0xFF, 0xF0, 0x00, 0x00,
		0x00, 0x0F, 0xFF, 0xF0, 0xFF, 0xFF, 0x00, 0x0F, 0xFF, 0x00, 0x0F, 0xFF, 0xF0, 0x0F, 0xFF, 0x00,
		0x0F, 0x00, 0x00, 0x0F, 0xFF, 0x00, 0xF0, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0xF0,
		0x0F, 0x00, 0x0F, 0xFF, 0x00, 0xF0, 0xF0, 0xF0, 0xF0, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xF0, 0x00,
		0x00, 0x00, 0x00, 0xF0, 0xF0, 0x00, 0x00, 0xFF, 0xFF, 0x00, 0x00, 0xFF, 0x00, 0x0F, 0xF0, 0xF0,
		0x00, 0xF0, 0x00, 0x0F, 0x0F, 0x00, 0xF0, 0x00, 0xF0, 0x0F, 0xFF, 0x00, 0xFF, 0xFF, 0xF0, 0x00,
		0x0F, 0x00, 0x00, 0xF0, 0x00, 0x0F, 0x00, 0x00, 0x00, 0x00, 0x00
};

static const uint16_t lcd_4bit_rgbi_palette[16] =
{
		0x0000,					// BLACK
		0x738E,					// DARK GREY
		0x0014,					// DARK BLUE
		0x001F,					// BLUE
		0x0440,					// DARK GREEN
		0x07E0,					// GREEN
		0x0492,					// DARK CYAN
		0x07FF,					// CYAN
		0xB800,					// DARK RED
		0xF800,					// RED
		0x9813,					// DARK PURPLE
		0xF81F,					// PURPLE
		0xC300,					// BROWN
		0xFFE0,					// YELLOW
		0xC618,					// GREY
		0xFFFF,					// WHITE
};

static uint8_t lcd_screen_buffer[2048] = {0,};				// Actual display resolution is 128 x 128 = 16384.
													// Practical resolution is 64 * 64 = 4096.
													// Using 4-bit color palette, we get 2 pixels in 1 byte
													// 4096 / 2 = 2048

static void lcd_port_init()
{
	LCD_SPICLK_SEL |= LCD_SPICLK_PIN;
	LCD_SPIMOSI_SEL |= LCD_SPIMOSI_PIN;
	LCD_RST_DIR |= LCD_RST_PIN;
	LCD_DC_DIR |= LCD_DC_PIN;
	LCD_CS_DIR |= LCD_CS_PIN;
}

// Assumes SMCLK @ 25.000.000 Hz
// Spi Runs @ 25.000.000 Hz
static void lcd_spi_init()
{
	UCB0CTL1 = UCSWRST;								// Held in reset state
	UCB0CTL0 = 	UCCKPH | 							// Data is captured on the first UCB0CLK edge and changed on the following edge.
				UCMSB | 							// MSB First
				UCMST | 							// Master mode
				UCSYNC;								// Synchronous mode (SPI/I2C)
	UCB0CTL1 |= UCSSEL__SMCLK;						// BRCLK is sourced from SMCLK
	UCB0BR0 = 0x00;									// Making UCB0CLK equals to UB0BRCLK
	UCB0BR1 = 0x00;
	UCB0CTL1 &= ~UCSWRST;							// Reset released for operation

	LCD_CS_OUT &= ~LCD_CS_PIN;
	LCD_DC_OUT |= LCD_DC_PIN;
}

static inline void lcd_write_command(uint8_t command)
{
    while((UCB0IFG & UCTXIFG) == 0);

    LCD_DC_OUT &= ~LCD_DC_PIN;

    UCB0TXBUF = command;

    while((UCB0IFG & UCTXIFG) == 0);

    LCD_DC_OUT |= LCD_DC_PIN;
}

static inline void lcd_write_data(uint8_t data)
{
	while((UCB0IFG & UCTXIFG) == 0);

    UCB0TXBUF = data;
}

static void lcd_set_draw_frame(uint8_t x0, uint8_t y0, uint8_t x1, uint8_t y1)
{
	x0 += LCD_COL_START;
	y0 += LCD_ROW_START;
	x1 += LCD_COL_START;
	y1 += LCD_ROW_START;

    lcd_write_command(CM_CASET);				// Column Address Set
    lcd_write_data((uint8_t)(x0 >> 8));
    lcd_write_data((uint8_t)(x0));
    lcd_write_data((uint8_t)(x1 >> 8));
    lcd_write_data((uint8_t)(x1));

    lcd_write_command(CM_RASET);				// Row Address Set
    lcd_write_data((uint8_t)(y0 >> 8));
    lcd_write_data((uint8_t)(y0));
    lcd_write_data((uint8_t)(y1 >> 8));
    lcd_write_data((uint8_t)(y1));
}

void lcd_init()
{
	lcd_port_init();
	lcd_spi_init();

	LCD_RST_OUT &= ~LCD_RST_PIN;				// Reset pulse
	timer_a0_delay_us(50*100);
	LCD_RST_OUT |= LCD_RST_PIN;
	timer_a0_delay_us(120*100);

	lcd_write_command(CM_SLPOUT);			// Sleep out
	timer_a0_delay_us(200*100);

	lcd_write_command(CM_GAMSET);			// Gamma curve select
	lcd_write_data(0x04);					// GC2 (if GS=1 => G2.5, if GS=0 => G2.2)

	lcd_write_command(CM_SETPWCTR);			// In Normal mode (full colors), Set the frame frequency of the full colors normal mode
	lcd_write_data(0x0A);
	lcd_write_data(0x14);

	lcd_write_command(CM_SETSTBA);			// Power Control Setting
	lcd_write_data(0x0A);					// AVDD -> 4.5, GVDD -> 4.2
	lcd_write_data(0x00);					// GVCL -> -4.7

	lcd_write_command(CM_COLMOD);			// Interface pixel format
	lcd_write_data(0x05);					// 16-bit per pixel
	timer_a0_delay_us(10*100);

	lcd_write_command(CM_MADCTL);			// Memory data acess control
	lcd_write_data(CM_MADCTL_MX | CM_MADCTL_MY | CM_MADCTL_BGR);	// Column Address Order, Row Address Order, BGR Order

	lcd_write_command(CM_NORON);			// Normal display mode on
    lcd_write_command(CM_DISPON);			// Display On
}

static inline void lcd_draw_full_image(uint8_t *image_base, const uint16_t *palette)
{
	uint16_t color;

	lcd_set_draw_frame(0,0,LCD_HORIZONTAL_MAX-1,LCD_VERTICAL_MAX-1);
	lcd_write_command(CM_RAMWR);						// Memory Write

	uint8_t coluna = 0;
	uint8_t count=0;
	uint8_t *image_ptr = image_base;
	uint32_t n_pixels = 16384;
	while(n_pixels)
	{
		color = palette[(*image_ptr) >> 4];

		lcd_write_data(color>>8);
		lcd_write_data(color);
		lcd_write_data(color>>8);
		lcd_write_data(color);

		n_pixels -= 2;

		if(n_pixels)
		{
			color = palette[(*image_ptr) & 0xF];

			lcd_write_data(color>>8);
			lcd_write_data(color);
			lcd_write_data(color>>8);
			lcd_write_data(color);

			n_pixels -= 2;

			image_ptr++;
			count += 4;
			if(count == 128)
			{
				count = 0;
				if(coluna == 0)
				{
					image_ptr -= 32;
				}
				coluna ^= 1;
			}
		}
	}
}

void lcd_clear_buffer()
{
	uint32_t i;
	for(i=0; i < 2048; i++)
	{
		lcd_screen_buffer[i] = (LCD_4BIT_RGBI_BLACK << 4) | LCD_4BIT_RGBI_BLACK;
	}
}

void lcd_display_buffer()
{
	lcd_draw_full_image(lcd_screen_buffer,lcd_4bit_rgbi_palette);
}

void lcd_print_on_buffer(int16_t x, int16_t y, const sprite_t *sprite, uint8_t black_as_transparent)
{
	uint16_t pos = y * LCD_MAX_COLS + x;
	uint8_t nibble_dir_screen_buffer = pos & 0x1;
	uint8_t nibble_dir_image = 0;
	pos >>= 1;
	uint16_t sprite_pos = 0;
	uint8_t i,j;
	for(i = 0; i < sprite->n_rows; i++)
	{
		for(j = 0; j < sprite->n_cols; j++)
		{
			uint8_t value;
			if(nibble_dir_image)
			{
				value = sprite->image[sprite_pos] & 0xF;
				sprite_pos++;
			} else
			{
				value = sprite->image[sprite_pos] >> 4;
			}
			uint8_t transparent = (value == LCD_4BIT_RGBI_BLACK) && black_as_transparent;
			uint8_t inside_bounds = ((x + j) <= (LCD_MAX_COLS - 1)) && ((y + i) <= (LCD_MAX_ROWS - 1)) &&
									((x + j) >= 0) && ((y + i) >= 0);
			if(nibble_dir_screen_buffer)
			{
				if(inside_bounds && (!transparent))
				{
					lcd_screen_buffer[pos] = (lcd_screen_buffer[pos] & 0xF0) | value;
				}
				pos++;
			} else
			{
				if(inside_bounds && (!transparent))
				{
					lcd_screen_buffer[pos] = (lcd_screen_buffer[pos] & 0xF) | (value << 4);
				}
			}
			nibble_dir_image ^= 1;
			nibble_dir_screen_buffer ^= 1;
		}
		pos = (y + (i+1)) * LCD_MAX_COLS + x;
		nibble_dir_screen_buffer = pos & 0x1;
		pos >>= 1;
	}
}

void lcd_print_char_on_buffer(int16_t x, int16_t y, uint8_t data)
{
	uint16_t pos_screen_buffer = y * LCD_MAX_COLS + x;
	uint8_t nibble_dir_screen_buffer = pos_screen_buffer & 0x1;
	uint16_t pos_image = (data - 0x20) * LCD_ASCII_CHAR_WIDTH;
	uint8_t nibble_dir_image = pos_image & 0x1;
	pos_screen_buffer >>= 1;
	pos_image >>= 1;
	uint8_t i,j;
	for(i = 0; i < LCD_ASCII_CHAR_HEIGHT; i++)
	{
		for(j = 0; j < LCD_ASCII_CHAR_WIDTH; j++)
		{
			uint8_t value;
			if(nibble_dir_image)
			{
				value = lcd_ascii_img[pos_image] & 0xF;
				pos_image++;
			} else
			{
				value = lcd_ascii_img[pos_image] >> 4;
			}
			uint8_t transparent = (value == LCD_4BIT_RGBI_BLACK);
			uint8_t inside_bounds = ((x + j) <= (LCD_MAX_COLS - 1)) && ((y + i) <= (LCD_MAX_ROWS - 1)) &&
									((x + j) >= 0) && ((y + i) >= 0);
			if(nibble_dir_screen_buffer)
			{
				if(inside_bounds && (!transparent))
				{
					lcd_screen_buffer[pos_screen_buffer] = (lcd_screen_buffer[pos_screen_buffer] & 0xF0) | value;
				}
				pos_screen_buffer++;
			} else
			{
				if(inside_bounds && (!transparent))
				{
					lcd_screen_buffer[pos_screen_buffer] = (lcd_screen_buffer[pos_screen_buffer] & 0xF) | (value << 4);
				}
			}
			nibble_dir_image ^= 1;
			nibble_dir_screen_buffer ^= 1;
		}
		pos_screen_buffer = (y + (i+1)) * LCD_MAX_COLS + x;
		pos_image = ((data - 0x20) * LCD_ASCII_CHAR_WIDTH) + ((i+1) * ((0x7E - 0x20 + 1) * LCD_ASCII_CHAR_WIDTH));
		nibble_dir_screen_buffer = pos_screen_buffer & 0x1;
		nibble_dir_image = pos_image & 0x1;
		pos_screen_buffer >>= 1;
		pos_image >>= 1;
	}
}

void lcd_print_string_on_buffer(int16_t x, int16_t y, char* data)
{
	uint16_t start_x = x;
	uint16_t i = 0;
	while(data[i] && (y <= ((LCD_MAX_ROWS - 1) - LCD_ASCII_CHAR_HEIGHT)))
	{
		if(x > ((LCD_MAX_COLS - 1) - LCD_ASCII_CHAR_WIDTH))
		{
			x = start_x;
			y += LCD_ASCII_CHAR_HEIGHT + 1;
		} else
		{
			lcd_print_char_on_buffer(x,y,(uint8_t)data[i]);
			x += LCD_ASCII_CHAR_WIDTH;
			i++;
		}
	}
}

void lcd_print_udec_on_buffer(int16_t x, int16_t y, uint16_t n)
{
	char str[6];
	if(n < 10)
	{
		str[0] = n + '0';
		str[1] = 0;
	} else if(n < 100)
	{
		str[0] = (n/10) + '0';
		str[1] = (n%10) + '0';
		str[2] = 0;
	} else if(n < 1000)
	{
		str[0] = (n/100) + '0';
		n = n % 100;
		str[1] = (n/10) + '0';
		str[2] = (n%10) + '0';
		str[3] = 0;
	} else if(n < 10000)
	{
		str[0] = (n/1000) + '0';
		n = n % 1000;
		str[1] = (n/100) + '0';
		n = n % 100;
		str[2] = (n/10) + '0';
		str[3] = (n%10) + '0';
		str[4] = 0;
	} else
	{
		str[0] = (n/10000) + '0';
		n = n % 10000;
		str[1] = (n/1000) + '0';
		n = n % 1000;
		str[2] = (n/100) + '0';
		n = n % 100;
		str[3] = (n/10) + '0';
		str[4] = (n%10) + '0';
		str[5] = 0;
	}
	lcd_print_string_on_buffer(x, y, str);
}
